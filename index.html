<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ノイキャン再現</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            width: 360px;
            text-align: center;
        }
        .mode-selector { margin-bottom: 20px; padding: 15px; background: #eee; border-radius: 8px; font-weight: bold; }
        .controls-box { background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        .control-group { margin: 10px 0; text-align: left; }
        .slider-label { display: flex; justify-content: space-between; font-weight: bold; font-size: 0.9rem; margin-bottom: 5px; }
        input[type="range"], input[type="file"] { width: 100%; cursor: pointer; }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        button { padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .toggle { background: #ddd; color: #333; }
        .toggle.active { background: #4A90E2; color: white; }
        .main-btn { width: 100%; color: white; font-size: 1.1rem; margin-top: 5px; }
        .btn-playing { background: #2ecc71; box-shadow: 0 4px #27ae60; }
        .btn-stopped { background: #e74c3c; box-shadow: 0 4px #c0392b; }
    </style>
</head>
<body>

<div class="container">
    <h3>ノイキャン実験</h3>
    
    <div class="mode-selector">
        <label><input type="radio" name="mode" value="osc" checked> 三角関数波</label>
        <label style="margin-left: 15px;"><input type="radio" name="mode" value="file"> 音源ファイル</label>
    </div>

    <div class="controls-box">
        <div id="osc-controls" class="control-group">
            <div class="slider-label"><span>音の高さ</span><span><span id="freq-display">440</span>Hz</span></div>
            <input type="range" id="freq-slider" min="100" max="1000" value="440">
        </div>

        <div id="file-controls" class="control-group" style="display: none;">
            <input type="file" id="audio-file" accept="audio/*,video/mp4,video/x-m4v,video/quicktime">
        </div>

        <div class="control-group">
            <div class="slider-label"><span>音の大きさ</span><span><span id="vol-display">50</span>%</span></div>
            <input type="range" id="vol-slider" min="0" max="100" value="100">
        </div>
    </div>

    <div class="btn-grid">
        <button id="left-btn" class="toggle active">左スピーカー</button>
        <button id="right-btn" class="toggle active">右スピーカー</button>
    </div>

    <button id="master-btn" class="main-btn btn-stopped">停止中</button>
</div>

<script>
    let audioCtx, osc, audioSource, gainL, gainR, masterGain, merger;
    let audioTag = new Audio();
    audioTag.crossOrigin = "anonymous";
    let isPlaying = false;
    let currentMode = 'osc';

    const masterBtn = document.getElementById('master-btn');
    const freqSlider = document.getElementById('freq-slider');
    const freqDisplay = document.getElementById('freq-display');
    const volSlider = document.getElementById('vol-slider');
    const volDisplay = document.getElementById('vol-display');
    const fileInput = document.getElementById('audio-file');

    document.querySelectorAll('input[name="mode"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            currentMode = e.target.value;
            document.getElementById('osc-controls').style.display = currentMode === 'osc' ? 'block' : 'none';
            document.getElementById('file-controls').style.display = currentMode === 'file' ? 'block' : 'none';
            stopAll();
        });
    });

    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            audioTag.src = URL.createObjectURL(file);
            audioTag.load();
        }
    });

    function init() {
        if (audioCtx) return;
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        gainL = audioCtx.createGain();
        gainR = audioCtx.createGain();
        masterGain = audioCtx.createGain();
        masterGain.gain.value = volSlider.value / 100;
        merger = audioCtx.createChannelMerger(2);
        
        // 出力の接続
        gainL.connect(merger, 0, 0); // 左チャンネル
        gainR.connect(merger, 0, 1); // 右チャンネル
        merger.connect(masterGain);
        masterGain.connect(audioCtx.destination);
    }

    function playCurrentMode() {
        init();
        if (audioCtx.state === 'suspended') audioCtx.resume();

        const inverter = audioCtx.createGain();
        inverter.gain.value = -1; // 逆位相装置

        if (currentMode === 'osc') {
            osc = audioCtx.createOscillator();
            osc.type = 'sine';
            osc.frequency.value = freqSlider.value;
            
            // 右にそのまま、左に逆位相
            osc.connect(gainR);
            osc.connect(inverter);
            inverter.connect(gainL);
            osc.start();
        } else {
            if (!audioSource) {
                audioSource = audioCtx.createMediaElementSource(audioTag);
            }
            // 右にそのまま、左に逆位相
            audioSource.connect(gainR);
            audioSource.connect(inverter);
            inverter.connect(gainL);
            audioTag.play();
        }
        
        isPlaying = true;
        masterBtn.textContent = "再生中";
        masterBtn.className = "main-btn btn-playing";
    }

    function stopAll() {
        if (osc) { try { osc.stop(); osc.disconnect(); } catch(e){} }
        audioTag.pause();
        if (audioSource) { try { audioSource.disconnect(); } catch(e){} }
        isPlaying = false;
        masterBtn.textContent = "停止中";
        masterBtn.className = "main-btn btn-stopped";
    }

    masterBtn.addEventListener('click', () => {
        if (isPlaying) stopAll();
        else playCurrentMode();
    });

    freqSlider.addEventListener('input', (e) => {
        freqDisplay.textContent = e.target.value;
        if (osc) osc.frequency.setTargetAtTime(e.target.value, audioCtx.currentTime, 0.01);
    });

    volSlider.addEventListener('input', (e) => {
        volDisplay.textContent = e.target.value;
        if (masterGain) masterGain.gain.setTargetAtTime(e.target.value / 100, audioCtx.currentTime, 0.01);
    });

    document.getElementById('left-btn').addEventListener('click', function() {
        this.classList.toggle('active');
        if (gainL) gainL.gain.value = this.classList.contains('active') ? 1 : 0;
    });

    document.getElementById('right-btn').addEventListener('click', function() {
        this.classList.toggle('active');
        if (gainR) gainR.gain.value = this.classList.contains('active') ? 1 : 0;
    });
</script>
</body>
</html>