<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ノイキャン再現</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
            padding: 15px;
            box-sizing: border-box;
        }
        .container {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 450px;
            text-align: center;
            box-sizing: border-box;
        }
        h3 { margin-bottom: 20px; color: #333; }
        .mode-selector { 
            margin-bottom: 20px; 
            padding: 12px; 
            background: #eee; 
            border-radius: 10px; 
            font-weight: bold;
            display: flex;
            justify-content: space-around;
        }
        .mode-selector label { cursor: pointer; flex: 1; padding: 5px; }
        
        .controls-box { background: #f9f9f9; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #eee; }
        .control-group { margin: 20px 0; text-align: left; }
        .slider-label { display: flex; justify-content: space-between; font-weight: bold; font-size: 1rem; margin-bottom: 10px; }
        
        /* スマホ向けにスライダーを巨大化 */
        input[type="range"] { 
            width: 100%; 
            height: 12px; 
            -webkit-appearance: none;
            background: #ddd;
            border-radius: 6px;
            outline: none;
            margin: 15px 0;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 32px;
            height: 32px;
            background: #4A90E2;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        input[type="file"] { 
            width: 100%; 
            padding: 10px; 
            background: #fff; 
            border: 1px solid #ddd; 
            border-radius: 6px;
            box-sizing: border-box;
        }

        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        button { padding: 18px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 1rem; }
        
        .toggle { background: #ddd; color: #333; }
        .toggle.active { background: #4A90E2; color: white; }
        
        .main-btn { width: 100%; color: white; font-size: 1.3rem; margin-top: 5px; padding: 22px; }
        .btn-playing { background: #2ecc71; box-shadow: 0 5px #27ae60; }
        .btn-stopped { background: #e74c3c; box-shadow: 0 5px #c0392b; }
        .main-btn:active { transform: translateY(3px); box-shadow: none; }
    </style>
</head>
<body>

<div class="container">
    <h3>ノイキャン実験</h3>
    
    <div class="mode-selector">
        <label><input type="radio" name="mode" value="osc" checked> 三角関数波</label>
        <label><input type="radio" name="mode" value="file"> 音源ファイル</label>
    </div>

    <div class="controls-box">
        <div id="osc-controls" class="control-group">
            <div class="slider-label"><span>音の高さ</span><span><span id="freq-display">440</span>Hz</span></div>
            <input type="range" id="freq-slider" min="100" max="1000" value="440">
        </div>

        <div id="file-controls" class="control-group" style="display: none;">
            <input type="file" id="audio-file" accept="audio/*,video/mp4,audio/mp4,audio/x-m4a,.m4a">
        </div>

        <div class="control-group">
            <div class="slider-label"><span>音の大きさ</span><span><span id="vol-display">100</span>%</span></div>
            <input type="range" id="vol-slider" min="0" max="100" value="100">
        </div>
    </div>

    <div class="btn-grid">
        <button id="left-btn" class="toggle active">左スピーカー</button>
        <button id="right-btn" class="toggle active">右スピーカー</button>
    </div>

    <button id="master-btn" class="main-btn btn-stopped">停止中</button>
</div>

<script>
    let audioCtx, osc, audioSource, gainL, gainR, masterGain, merger;
    let audioTag = new Audio();
    audioTag.crossOrigin = "anonymous";
    let isPlaying = false;
    let currentMode = 'osc';

    const masterBtn = document.getElementById('master-btn');
    const freqSlider = document.getElementById('freq-slider');
    const freqDisplay = document.getElementById('freq-display');
    const volSlider = document.getElementById('vol-slider');
    const volDisplay = document.getElementById('vol-display');
    const fileInput = document.getElementById('audio-file');

    document.querySelectorAll('input[name="mode"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            currentMode = e.target.value;
            document.getElementById('osc-controls').style.display = currentMode === 'osc' ? 'block' : 'none';
            document.getElementById('file-controls').style.display = currentMode === 'file' ? 'block' : 'none';
            stopAll();
        });
    });

    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            audioTag.src = URL.createObjectURL(file);
            audioTag.load();
        }
    });

    function init() {
        if (audioCtx) return;
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        gainL = audioCtx.createGain();
        gainR = audioCtx.createGain();
        masterGain = audioCtx.createGain();
        // 初期値をスライダーの現在値（100）に設定
        masterGain.gain.value = volSlider.value / 100;
        merger = audioCtx.createChannelMerger(2);
        
        gainL.connect(merger, 0, 0); 
        gainR.connect(merger, 0, 1); 
        merger.connect(masterGain);
        masterGain.connect(audioCtx.destination);
    }

    function playCurrentMode() {
        init();
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const inverter = audioCtx.createGain();
        inverter.gain.value = -1;

        if (currentMode === 'osc') {
            osc = audioCtx.createOscillator();
            osc.type = 'sine';
            osc.frequency.value = freqSlider.value;
            osc.connect(gainR);
            osc.connect(inverter);
            inverter.connect(gainL);
            osc.start();
        } else {
            if (!audioSource) audioSource = audioCtx.createMediaElementSource(audioTag);
            audioSource.connect(gainR);
            audioSource.connect(inverter);
            inverter.connect(gainL);
            audioTag.play();
        }
        
        isPlaying = true;
        masterBtn.textContent = "再生中";
        masterBtn.className = "main-btn btn-playing";
    }

    function stopAll() {
        if (osc) { try { osc.stop(); osc.disconnect(); } catch(e){} }
        audioTag.pause();
        if (audioSource) { try { audioSource.disconnect(); } catch(e){} }
        isPlaying = false;
        masterBtn.textContent = "停止中";
        masterBtn.className = "main-btn btn-stopped";
    }

    masterBtn.addEventListener('click', () => {
        if (isPlaying) stopAll();
        else playCurrentMode();
    });

    freqSlider.addEventListener('input', (e) => {
        freqDisplay.textContent = e.target.value;
        if (osc) osc.frequency.setTargetAtTime(e.target.value, audioCtx.currentTime, 0.01);
    });

    volSlider.addEventListener('input', (e) => {
        volDisplay.textContent = e.target.value;
        if (masterGain) masterGain.gain.setTargetAtTime(e.target.value / 100, audioCtx.currentTime, 0.01);
    });

    document.getElementById('left-btn').addEventListener('click', function() {
        this.classList.toggle('active');
        if (gainL) gainL.gain.value = this.classList.contains('active') ? 1 : 0;
    });

    document.getElementById('right-btn').addEventListener('click', function() {
        this.classList.toggle('active');
        if (gainR) gainR.gain.value = this.classList.contains('active') ? 1 : 0;
    });
</script>
</body>
</html>